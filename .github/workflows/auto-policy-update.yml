name: Auto-Update Policies with AI

on:
  schedule:
    # Run weekly on Monday at midnight UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all policies (not just changes)'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run - do not create PR'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install beautifulsoup4 requests pyyaml pydantic openai anthropic jsonpath-ng
      
      - name: Crawl policies and detect changes
        id: crawl
        run: |
          cd src
          python -c "
          import json
          from scrapers import ApplePolicyScraper, GooglePolicyScraper
          
          apple = ApplePolicyScraper()
          google = GooglePolicyScraper()
          
          apple_policies = apple.fetch_policies()
          google_policies = google.fetch_policies()
          
          apple_updates = apple.detect_changes(apple_policies)
          google_updates = google.detect_changes(google_policies)
          
          # Save cache for later use
          apple.save_cache(apple_policies)
          google.save_cache(google_policies)
          
          result = {
              'apple_policies': len(apple_policies),
              'google_policies': len(google_policies),
              'apple_updates': len(apple_updates),
              'google_updates': len(google_updates),
              'has_changes': len(apple_updates) + len(google_updates) > 0
          }
          
          print(f'Apple policies: {len(apple_policies)}, updates: {len(apple_updates)}')
          print(f'Google policies: {len(google_policies)}, updates: {len(google_updates)}')
          
          # Output for GitHub Actions
          with open('${{ github.workspace }}/crawl_result.json', 'w') as f:
              json.dump(result, f)
          "
          
          # Set output
          HAS_CHANGES=$(python -c "import json; print(json.load(open('${{ github.workspace }}/crawl_result.json'))['has_changes'])")
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
      
      - name: Generate rules with AI
        if: steps.crawl.outputs.has_changes == 'True' || github.event.inputs.force_update == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            python scripts/ai_update_rules.py --force
          else
            python scripts/ai_update_rules.py
          fi
      
      - name: Validate AI-generated rules (Dry-Run)
        if: steps.crawl.outputs.has_changes == 'True' || github.event.inputs.force_update == 'true'
        run: |
          # Validate that new rules meet the strict schema and don't crash the engine
          python scripts/validate_new_rules.py --rules-file src/rules/rules.yaml
      
      - name: Run tests
        run: |
          pip install pytest
          pytest tests/ -v --tb=short
      
      - name: Check for file changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain src/rules/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Rules file has been modified"
            git diff src/rules/rules.yaml
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No changes to rules file"
          fi
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Auto-update policy rules via AI"
          title: "ðŸ”„ Policy Update: AI-generated rule changes"
          body: |
            ## ðŸ¤– Automated Policy Update
            
            This PR was automatically generated by the policy crawler with AI assistance.
            
            ### ðŸ“Š Crawl Summary
            - Apple policies checked
            - Google policies checked
            - Rules generated/updated via AI
            
            ### âœ… Verification
            - All tests passed
            - Rules validated against schema
            
            ### ðŸ“ Changes
            See the diff in `src/rules/rules.yaml` for detailed changes.
            
            ---
            
            > [!IMPORTANT]
            > **Please review the generated rules carefully before merging.**
            > AI-generated rules may require manual adjustment.
          branch: auto-policy-update
          delete-branch: true
          labels: |
            policy-update
            automated
            ai-generated
          reviewers: ${{ github.repository_owner }}
      
      - name: Notify Discord on Failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d '{"content": "ðŸš¨ **Policy Update Failed!**\n\nThe automated policy update workflow encountered an error. Please check the logs immediately.\n\nðŸ”— [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}' \
          $DISCORD_WEBHOOK_URL

      - name: Notify Discord on Success
        if: success() && steps.check_changes.outputs.changes == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d '{"content": "âœ… **New Policy Rules Detected!**\n\nA Pull Request has been created with the latest AI-generated rules.\n\nðŸ”— [View Pull Requests](${{ github.server_url }}/${{ github.repository }}/pulls)"}' \
          $DISCORD_WEBHOOK_URL

      - name: Notify Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸš¨ POLICY UPDATE FAILED: ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: "Policy Checker Bot"
          body: |
            The auto-policy update workflow has failed.
            
            Likely causes:
            - Scraper issues due to HTML structure changes
            - Network connectivity problems
            - Script execution errors
            
            Please check the logs immediately to diagnose the issue:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Regards,
            Policy Checker Bot

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Policy Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "âœ… New rules generated and PR created" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“­ No policy changes detected" >> $GITHUB_STEP_SUMMARY
          fi
